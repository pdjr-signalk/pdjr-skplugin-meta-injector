"use strict";(self.webpackChunkpdjr_skplugin_metadata=self.webpackChunkpdjr_skplugin_metadata||[]).push([[303],{473:(e,t,a)=>{a.r(t),a.d(t,{default:()=>o});var l=a(624),s=a.n(l),n=a(264),r=a(239);class c extends s().Component{constructor(e){super(e),this.state={urls:e.urls?e.urls:{metadata:"/plugins/metadata/keys",config:"/plugins/metadata/keys",paths:"/plugins/metadata/paths"},scope:e.defaultScope?e.defaultScope:"metadata",metadata_key:null,metadata_value:null,button_save_disabled:!0,button_saveas_disabled:!0,button_delete_disabled:!0}}render(){return this.changeScope("metadata"),s().createElement(n.l0,{className:"square rounded border",style:{padding:"5px"}},s().createElement(n.cw,null,s().createElement(n.cw,{row:!0,style:{height:"60px"}},s().createElement(n.JX,null,s().createElement(r.ZP,{name:"selectItem",controlShouldRenderValue:!0,loadOptions:this.loadPathOptions,defaultOptions:!0,key:JSON.stringify(this.state.scope),value:this.state.metadata_key,onChange:this.changeMetadataKey}),s().createElement("div",{class:"scope-buttons"},s().createElement("label",null,s().createElement("input",{type:"radio",name:"selectScope",value:"metadata",checked:"metadata"===this.state.scope,onChange:e=>this.changeScope(e.target.value)})," metadata "),"    ",s().createElement("label",null,s().createElement("input",{type:"radio",name:"selectScope",value:"config",checked:"config"===this.state.scope,onChange:e=>this.changeScope(e.target.value)})," config "),"    ",s().createElement("label",null,s().createElement("input",{type:"radio",name:"selectScope",value:"paths",checked:"paths"===this.state.scope,onChange:e=>this.changeScope(e.target.value)})," paths "),"    "))),s().createElement(n.cw,{row:!0,style:{height:"300px"}},s().createElement(n.JX,null,s().createElement("textarea",{name:"metadata",rows:"12",wrap:"off",style:{width:"100%"},value:this.state.metadata_value,onChange:e=>changeMetadata(e.value)}))),s().createElement(n.cw,{row:!0},s().createElement(n.JX,null,s().createElement(n.Si,{style:{justifyContent:"space-between"}},s().createElement(n.Si,null,s().createElement(n.zx,{name:"save",size:"sm",color:"primary",disabled:this.state.button_save_disabled,onClick:e=>{e.preventDefault(),onSave()}},s().createElement("i",{className:"fa fa-save"})," Save ")," ",s().createElement(n.zx,{name:"saveAs",size:"sm",color:"primary",disabled:this.state.button_saveas_disabled,onClick:e=>{e.preventDefault(),onSaveAs()}},s().createElement("i",{className:"fa fa-save"})," Save As ")," "),s().createElement(n.Si,null,s().createElement(n.zx,{name:"delete",size:"sm",color:"danger",disabled:this.state.button_delete_disabled,onClick:e=>{e.preventDefault(),onDelete()}},s().createElement("i",{className:"fa fa-ban"})," Delete ")))))))}changeScope=e=>{this.setState({scope:e,metadata_key:null,metadata_value:null})};changeMetadataKey=e=>{this.setState({metadata_key:e,button_save_disabled:!0,button_saveas_disabled:!0,button_delete_disabled:!0}),null!=e&&fetch(this.state.urls[this.state.scope]+"/"+e.value,{credentials:"include"}).then((e=>{e.json().then((e=>{delete e.value.timestamp,delete e.value.$source,this.changeMetadataValue(JSON.stringify(e.value,null,2))})).catch((e=>{alert("The metadata value for '"+e.value+"' is not valid JSON")}))})).catch((e=>{alert("The metadata value for '"+e.value+"' could not be retrieved")}))};changeMetadataValue=e=>{this.setState({metadata_value:e||"",button_save_disabled:null===e||"paths"===selectScope,button_saveas_disabled:null===e,button_delete_disabled:null===e||"paths"===selectScope})};loadPathOptions=(e,t)=>{this.setState({metadata_key:null}),fetch(this.state.urls[this.state.scope],{credentials:"include"}).then((e=>{e.json().then((e=>{switch(this.state.select){case"metadata":t(e.keys.filter((e=>!e.startsWith("."))).map((e=>({value:e,label:e}))));break;case"config":t(e.keys.filter((e=>e.startsWith("."))).map((e=>({value:e,label:e}))));break;case"paths":t(e.keys.map((e=>({value:e,label:e}))))}}))}))};onSave=()=>{try{var[e,t]=validateMetdata(this.state.metadata_key?this.state.metadata_key.value:null,this.state.metadata_value);fetch("/plugins/metadata/keys/"+e,{credentials:"include",method:"PUT",headers:{"Content-type":"application/json"},body:t}).then((e=>{if(200!=e.status)throw new Error("Server rejected save request (Error "+e.status+")")}))}catch(e){alert(e.message)}};onSaveAs=()=>{try{if(e=prompt("Enter name of new metadata key")){var[e,t]=validateMetadata(e,this.state.metadata_value);fetch("/plugins/metadata/keys/"+e,{credentials:"include",method:"PUT",headers:{"Content-type":"application/json"},body:t}).then((e=>{if(200!=e.status)throw new Error("Server rejected save request (Error "+e.status+")")}))}}catch(e){alert(e.message)}};onDelete=()=>{try{var e=this.state.metadata_key?this.state.metadata_key.value:null;if(null===e)throw new Error("invalid key value");confirm("Really delete metadata for "+e)&&fetch("/plugins/metadata/keys/"+e,{credentials:"include",method:"PUT",headers:{"Content-type":"application/json"},body:null}).then((e=>{if(200!=e.status)throw new Error("Server rejected delete request (Error "+e.status+")");var t=selectScope;this.setState({scope:null}),this.setState({scope:t,metadata_value:null})}))}catch(e){alert(e.message)}};validateMetdata=(e,t)=>{var a,l;if(console.log("validating %s %s",e,t),null!==e){if((a=e.trim()).length>0){if(t){l=t.trim();try{l=JSON.parse(l)}catch(e){throw new Error("matadata value is not valid JSON")}if("object"==typeof l)return[a,JSON.stringify(l)];throw new Error("metadata value is not a JSON object")}throw new Error("metadata value is null")}throw new Error("key is blank")}throw new Error("key is null")}}const i=c,o=e=>{const t=new i(e);return s().createElement(n.Zb,null,s().createElement(n.Ol,null,"Metadata Configuration"),s().createElement(n.eW,null,s().createElement("div",null,s().createElement("div",{style:{float:"left",width:"49%"}},s().createElement(m,{configuration:e.configuration,save:t=>e.save(t)})),s().createElement("div",{style:{float:"right",width:"49%"}},t))))},d={lineHeight:"36px"},u=({type:e,fieldName:t,label:a,value:l,setter:r,text:c})=>s().createElement(n.cw,{row:!0},s().createElement(n.JX,{md:"6"},s().createElement(n.__,{style:d,htmlFor:t},a)),s().createElement(n.JX,{md:"6"},"checkbox"==e?s().createElement(n.II,{type:"checkbox",name:t,onChange:e=>r(e.target.checked),checked:l}):"","text"==e?s().createElement(n.II,{type:"text",name:t,onChange:e=>r(e.target.value),value:l}):"",s().createElement(n.R9,{color:"muted"},c))),m=({configuration:e,save:t})=>{const[a,r]=(0,l.useState)(e.resourceType),[c,i]=(0,l.useState)(e.startDelay),[o,d]=(0,l.useState)((()=>e.excludePaths.sort().join(", "))),[m,h]=(0,l.useState)(e.persist);return s().createElement(n.l0,{className:"square rounded border",style:{padding:"5px"}},s().createElement(n.cw,{row:!0,style:{height:"60px"}},s().createElement(n.JX,null,s().createElement(u,{type:"text",fieldName:"resourceType",label:"Metadata resource type",value:a,setter:r,text:""}))),s().createElement(n.cw,{row:!0,style:{height:"300px"}},s().createElement(n.JX,null,s().createElement(u,{type:"text",fieldName:"startDelay",label:"Start delay",value:c,setter:i,text:""}),s().createElement(u,{type:"text",fieldName:"excludePathsString",label:"Exclude paths beginning with",value:o,setter:d,text:""}),s().createElement(u,{type:"checkbox",fieldName:"persist",label:"Persist dynamic changes",value:m,setter:h,text:""}))),s().createElement(n.cw,{row:!0},s().createElement(n.JX,null,s().createElement(n.Si,{style:{justifyContent:"space-between"}},s().createElement(n.Si,null,s().createElement(n.zx,{size:"sm",color:"primary",onClick:e=>{e.preventDefault(),t({resourceType:a,startDelay:c,excludePaths:o.split(/,/).map((e=>e.trim())).sort(),persist:m})}},s().createElement("i",{className:"fa fa-save"})," Save ")," ",s().createElement(n.zx,{size:"sm",color:"primary",onClick:t=>{t.preventDefault(),r(e.resourceType),i(e.startDelay),d(e.excludePaths.sort().join(", ")),h(e.persist)}},s().createElement("i",{className:"fa fa-ban"})," Cancel ")),s().createElement(n.Si,null,s().createElement(n.zx,{size:"sm",color:"danger",onClick:e=>{e.preventDefault(),confirm("Compose will rebuild metadata from configuration files. New metadata entities may be created and existing metadata entities may be updated. Proceed?")&&fetch("/plugins/metadata/compose",{credentials:"include",method:"PUT"}).then((e=>{200!==e.status&&alert("Compose request failed ("+e.status+")")}))}},s().createElement("i",{className:"fa fa-save"})," Compose ")," ",s().createElement(n.zx,{size:"sm",color:"danger",onClick:e=>{e.preventDefault(),confirm("Snaphot will capture live Signal K metadata into the current metadata resource. New metadata entities may be created and existing metadata entities may be updated. Proceed?")&&fetch("/plugins/metadata/snapshot",{credentials:"include",method:"PUT"}).then((e=>{200!==e.status&&alert("Snapshot request failed ("+e.status+")")}))}},s().createElement("i",{className:"fa fa-save"})," Snapshot "))))))}}}]);